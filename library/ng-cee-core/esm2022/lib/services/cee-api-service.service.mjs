import { Injectable } from '@angular/core';
import { HttpHeaders } from '@angular/common/http';
import { FlatUnflat } from '../utils/flat-unflat-json';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "../models/app-data/app-data.service";
import * as i3 from "../models/api-data/api-data.service";
export class CeeApiService {
    http;
    appDataService;
    apiDataService;
    requestMappingData;
    configurationData;
    fileData;
    downloadData = false;
    downloadZip = false;
    environment = {};
    stepId = '';
    adminStepIds = [];
    flatUnflat;
    constructor(http, appDataService, apiDataService) {
        this.http = http;
        this.appDataService = appDataService;
        this.apiDataService = apiDataService;
        this.flatUnflat = new FlatUnflat(appDataService);
    }
    setStepId(id) {
        this.stepId = id;
    }
    ESBRequestHandler(url, body, apiConfig) {
        // HIT Service BUS API
        const requestBody = body;
        // console.log(requestBody);
        if (requestBody !== undefined) {
            requestBody['api_request'] =
                JSON.stringify(this.flatUnflat.createNestedObject(this.flatUnflat.createRequestBodyonStepBlockData(body, this.stepId)));
        }
        return this.http.post(localStorage.getItem('URL') + url, requestBody, {});
    }
    ExternalAPIHandler(apiConfig) {
        let appData = [];
        let apiData = [];
        const body = {};
        let methodType = '';
        // const requestType = 'application/json';
        const urlParams = [];
        const queryParams = [];
        const headerParams = [];
        let requestBody = [];
        // store the appData
        this.appDataService.getAllAppData().subscribe(res => {
            if (localStorage.getItem('singleApiKey') === 'true') {
                appData = res;
            }
            else {
                let finalArr = [];
                for (const data of res) {
                    let obj = {};
                    const arr = [];
                    for (const requestKey of data['requestApiKey']) {
                        obj = data;
                        obj = { ...obj, apiKey: requestKey };
                        arr.push(obj);
                    }
                    finalArr = [...finalArr, ...arr];
                }
                appData = finalArr;
            }
            // console.log('app Data', appData);
        });
        // store the apiData
        this.apiDataService.getAllApiData().subscribe(res => {
            // console.log('apiData', res);
            apiData = res;
        });
        for (const singleAppData of appData) {
            body[singleAppData.apiKey] = singleAppData.value;
        }
        for (const singleApiData of apiData) {
            body[singleApiData.apiKey] = singleApiData.value;
        }
        if (Object.keys(apiConfig).length > 0) {
            methodType = apiConfig['methodType'];
            if (apiConfig['urlParams'].length > 0) {
                for (const singleParam of apiConfig['urlParams']) {
                    urlParams.push(body[singleParam]);
                }
            }
            if (apiConfig['queryParams'].length > 0) {
                for (const singleParam of apiConfig['queryParams']) {
                    const obj = {};
                    obj[singleParam] = body[singleParam];
                    queryParams.push(obj);
                }
            }
            if (apiConfig['headerParams'].length > 0) {
                for (const singleParam of apiConfig['headerParams']) {
                    const obj = {};
                    obj[singleParam] = body[singleParam];
                    headerParams.push(obj);
                }
            }
            if (apiConfig['requestBody'].length > 0) {
                requestBody = apiConfig['requestBody'];
            }
        }
        else {
            methodType = 'POST';
        }
        return this.ceeApiService(apiConfig['url'], methodType, body, urlParams, queryParams, headerParams, requestBody);
    }
    /**
     * function returns teh formatted body if the requestBody key in the
     * api config object has a length > 0
     * @param bodyObj
     * @param apiConfigBodyArr
     */
    returnFormattedRequestBody(bodyObj, apiConfigBodyArr) {
        const flattendBody = this.flatUnflat.flattenJSON(bodyObj);
        let body = {};
        for (const singlekey of apiConfigBodyArr) {
            if (singlekey.includes('*')) {
                // console.log(singlekey);
                const matched = {};
                const regex = singlekey.replace('[*]', '\\[\\d+\\]');
                // tslint:disable-next-line: forin
                for (const key in flattendBody) {
                    const result = key.match(new RegExp(regex));
                    if (result) {
                        matched[key] = flattendBody[key];
                    }
                }
                body = { ...body, ...matched };
            }
            else {
                if (flattendBody.hasOwnProperty(singlekey)) {
                    body[singlekey] = flattendBody[singlekey];
                }
            }
        }
        return this.flatUnflat.createNestedObject(body);
    }
    /**
     * function that will hit the api
     * Note: for now only application/json type is supported
     */
    ceeApiService(url, method, body, urlParams, queryParams, headerParams, apiConfigRequestBody) {
        const URLParam = urlParams.length > 0 ? urlParams.join('/') : '';
        const queryParam = queryParams.map((key) => {
            return Object.keys(key).map(data => {
                return data + '=' + key[data];
            })[0];
        }).join('&');
        let headers = new HttpHeaders();
        headers = headers.append('Content-Type', 'application/json');
        headerParams.forEach(key => {
            Object.keys(key).forEach(data => {
                headers = headers.append(data, key[data]);
            });
        });
        switch (method) {
            case 'POST':
                return this.http.post(url +
                    (URLParam ? '/' + URLParam : '') +
                    (queryParam ? '?' + queryParam : ''), apiConfigRequestBody.length > 0 ? this.returnFormattedRequestBody(body, apiConfigRequestBody) : body, { headers, observe: 'response' });
            case 'PUT':
                return this.http.put(url +
                    (URLParam ? '/' + URLParam : '') +
                    (queryParam ? '?' + queryParam : ''), apiConfigRequestBody.length > 0 ? this.returnFormattedRequestBody(body, apiConfigRequestBody) : body, { headers, observe: 'response' });
            case 'GET':
                return this.http.get(url +
                    (URLParam ? '/' + URLParam : '') +
                    (queryParam ? '?' + queryParam : ''), { headers, observe: 'response' });
            case 'PATCH':
                return this.http.patch(url +
                    (URLParam ? '/' + URLParam : '') +
                    (queryParam ? '?' + queryParam : ''), apiConfigRequestBody.length > 0 ? this.returnFormattedRequestBody(body, apiConfigRequestBody) : body, { headers, observe: 'response' });
            case 'DELETE':
                return this.http.delete(url +
                    (URLParam ? '/' + URLParam : '') +
                    (queryParam ? '?' + queryParam : ''), { headers, observe: 'response' });
        }
    }
    static ɵfac = function CeeApiService_Factory(t) { return new (t || CeeApiService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.AppDataService), i0.ɵɵinject(i3.ApiDataService)); };
    static ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: CeeApiService, factory: CeeApiService.ɵfac, providedIn: 'root' });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(CeeApiService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], () => [{ type: i1.HttpClient }, { type: i2.AppDataService }, { type: i3.ApiDataService }], null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2VlLWFwaS1zZXJ2aWNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9Bbmd1bGFyLTE3L0VTRi1Bbmd1bGFyLVdGRS1MaWJyYXJ5L3Byb2plY3RzL25nLWNlZS1jb3JlL3NyYy9saWIvc2VydmljZXMvY2VlLWFwaS1zZXJ2aWNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQTBCLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRzNFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQzs7Ozs7QUFNdkQsTUFBTSxPQUFPLGFBQWE7SUFZVjtJQUNBO0lBQ0E7SUFiWixrQkFBa0IsQ0FBTTtJQUN4QixpQkFBaUIsQ0FBTTtJQUN2QixRQUFRLENBQU07SUFDZCxZQUFZLEdBQUcsS0FBSyxDQUFDO0lBQ3JCLFdBQVcsR0FBRyxLQUFLLENBQUM7SUFDcEIsV0FBVyxHQUFXLEVBQUUsQ0FBQztJQUN6QixNQUFNLEdBQUcsRUFBRSxDQUFDO0lBQ1osWUFBWSxHQUFVLEVBQUUsQ0FBQztJQUNqQixVQUFVLENBQWE7SUFFL0IsWUFDWSxJQUFnQixFQUNoQixjQUE4QixFQUM5QixjQUE4QjtRQUY5QixTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFFdEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lBRUQsU0FBUyxDQUFDLEVBQVU7UUFDaEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUVELGlCQUFpQixDQUFDLEdBQVcsRUFBRSxJQUFhLEVBQUUsU0FBa0I7UUFDNUQsc0JBQXNCO1FB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LENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO29CQUNoQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQ3BDLG9CQUFvQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLEVBQUUsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUNwRyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztZQUMxQyxLQUFLLFFBQVE7Z0JBQ1QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FDbkIsR0FBRztvQkFDSCxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO29CQUNoQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQ3BDLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1NBQzdDO0lBQ0wsQ0FBQzt1RUEzTlEsYUFBYTtnRUFBYixhQUFhLFdBQWIsYUFBYSxtQkFGVixNQUFNOztpRkFFVCxhQUFhO2NBSHpCLFVBQVU7ZUFBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cFBhcmFtcywgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IEFwcERhdGFTZXJ2aWNlIH0gZnJvbSAnLi4vbW9kZWxzL2FwcC1kYXRhL2FwcC1kYXRhLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBGbGF0VW5mbGF0IH0gZnJvbSAnLi4vdXRpbHMvZmxhdC11bmZsYXQtanNvbic7XHJcbmltcG9ydCB7IEFwaURhdGFTZXJ2aWNlIH0gZnJvbSAnLi4vbW9kZWxzL2FwaS1kYXRhL2FwaS1kYXRhLnNlcnZpY2UnO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBDZWVBcGlTZXJ2aWNlIHtcclxuICAgIHJlcXVlc3RNYXBwaW5nRGF0YTogYW55O1xyXG4gICAgY29uZmlndXJhdGlvbkRhdGE6IGFueTtcclxuICAgIGZpbGVEYXRhOiBhbnk7XHJcbiAgICBkb3dubG9hZERhdGEgPSBmYWxzZTtcclxuICAgIGRvd25sb2FkWmlwID0gZmFsc2U7XHJcbiAgICBlbnZpcm9ubWVudDogb2JqZWN0ID0ge307XHJcbiAgICBzdGVwSWQgPSAnJztcclxuICAgIGFkbWluU3RlcElkczogYW55W10gPSBbXTtcclxuICAgIHByaXZhdGUgZmxhdFVuZmxhdDogRmxhdFVuZmxhdDtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXHJcbiAgICAgICAgcHJpdmF0ZSBhcHBEYXRhU2VydmljZTogQXBwRGF0YVNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSBhcGlEYXRhU2VydmljZTogQXBpRGF0YVNlcnZpY2VcclxuICAgICkge1xyXG4gICAgICAgIHRoaXMuZmxhdFVuZmxhdCA9IG5ldyBGbGF0VW5mbGF0KGFwcERhdGFTZXJ2aWNlKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRTdGVwSWQoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuc3RlcElkID0gaWQ7XHJcbiAgICB9XHJcblxyXG4gICAgRVNCUmVxdWVzdEhhbmRsZXIodXJsOiBzdHJpbmcsIGJvZHk/OiBvYmplY3QsIGFwaUNvbmZpZz86IG9iamVjdCkge1xyXG4gICAgICAgIC8vIEhJVCBTZXJ2aWNlIEJVUyBBUElcclxuICAgICAgICBjb25zdCByZXF1ZXN0Qm9keSA9IGJvZHk7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2cocmVxdWVzdEJvZHkpO1xyXG4gICAgICAgIGlmIChyZXF1ZXN0Qm9keSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHJlcXVlc3RCb2R5WydhcGlfcmVxdWVzdCddID1cclxuICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHRoaXMuZmxhdFVuZmxhdC5jcmVhdGVOZXN0ZWRPYmplY3QodGhpcy5mbGF0VW5mbGF0LmNyZWF0ZVJlcXVlc3RCb2R5b25TdGVwQmxvY2tEYXRhKGJvZHksIHRoaXMuc3RlcElkKSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ1VSTCcpICsgdXJsLCByZXF1ZXN0Qm9keSwge30pO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBFeHRlcm5hbEFQSUhhbmRsZXIoYXBpQ29uZmlnOiBvYmplY3QpIHtcclxuXHJcbiAgICAgICAgbGV0IGFwcERhdGEgPSBbXTtcclxuICAgICAgICBsZXQgYXBpRGF0YSA9IFtdO1xyXG5cclxuICAgICAgICBjb25zdCBib2R5ID0ge307XHJcblxyXG4gICAgICAgIGxldCBtZXRob2RUeXBlID0gJyc7XHJcbiAgICAgICAgLy8gY29uc3QgcmVxdWVzdFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7XHJcbiAgICAgICAgY29uc3QgdXJsUGFyYW1zID0gW107XHJcbiAgICAgICAgY29uc3QgcXVlcnlQYXJhbXMgPSBbXTtcclxuICAgICAgICBjb25zdCBoZWFkZXJQYXJhbXMgPSBbXTtcclxuICAgICAgICBsZXQgcmVxdWVzdEJvZHkgPSBbXTtcclxuXHJcbiAgICAgICAgLy8gc3RvcmUgdGhlIGFwcERhdGFcclxuICAgICAgICB0aGlzLmFwcERhdGFTZXJ2aWNlLmdldEFsbEFwcERhdGEoKS5zdWJzY3JpYmUocmVzID0+IHtcclxuICAgICAgICAgICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzaW5nbGVBcGlLZXknKSA9PT0gJ3RydWUnKSB7XHJcbiAgICAgICAgICAgICAgICBhcHBEYXRhID0gcmVzO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGV0IGZpbmFsQXJyID0gW107XHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGRhdGEgb2YgcmVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9iaiA9IHt9O1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcmVxdWVzdEtleSBvZiBkYXRhWydyZXF1ZXN0QXBpS2V5J10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqID0gZGF0YTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqID0geyAuLi5vYmosIGFwaUtleTogcmVxdWVzdEtleSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcnIucHVzaChvYmopO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBmaW5hbEFyciA9IFsuLi5maW5hbEFyciwgLi4uYXJyXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGFwcERhdGEgPSBmaW5hbEFycjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnYXBwIERhdGEnLCBhcHBEYXRhKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8gc3RvcmUgdGhlIGFwaURhdGFcclxuICAgICAgICB0aGlzLmFwaURhdGFTZXJ2aWNlLmdldEFsbEFwaURhdGEoKS5zdWJzY3JpYmUocmVzID0+IHtcclxuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2FwaURhdGEnLCByZXMpO1xyXG4gICAgICAgICAgICBhcGlEYXRhID0gcmVzO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IHNpbmdsZUFwcERhdGEgb2YgYXBwRGF0YSkge1xyXG4gICAgICAgICAgICBib2R5W3NpbmdsZUFwcERhdGEuYXBpS2V5XSA9IHNpbmdsZUFwcERhdGEudmFsdWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IHNpbmdsZUFwaURhdGEgb2YgYXBpRGF0YSkge1xyXG4gICAgICAgICAgICBib2R5W3NpbmdsZUFwaURhdGEuYXBpS2V5XSA9IHNpbmdsZUFwaURhdGEudmFsdWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoT2JqZWN0LmtleXMoYXBpQ29uZmlnKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIG1ldGhvZFR5cGUgPSBhcGlDb25maWdbJ21ldGhvZFR5cGUnXTtcclxuICAgICAgICAgICAgaWYgKGFwaUNvbmZpZ1sndXJsUGFyYW1zJ10ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBzaW5nbGVQYXJhbSBvZiBhcGlDb25maWdbJ3VybFBhcmFtcyddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXJsUGFyYW1zLnB1c2goYm9keVtzaW5nbGVQYXJhbV0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoYXBpQ29uZmlnWydxdWVyeVBhcmFtcyddLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgc2luZ2xlUGFyYW0gb2YgYXBpQ29uZmlnWydxdWVyeVBhcmFtcyddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2JqID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqW3NpbmdsZVBhcmFtXSA9IGJvZHlbc2luZ2xlUGFyYW1dO1xyXG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5UGFyYW1zLnB1c2gob2JqKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGFwaUNvbmZpZ1snaGVhZGVyUGFyYW1zJ10ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBzaW5nbGVQYXJhbSBvZiBhcGlDb25maWdbJ2hlYWRlclBhcmFtcyddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2JqID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqW3NpbmdsZVBhcmFtXSA9IGJvZHlbc2luZ2xlUGFyYW1dO1xyXG4gICAgICAgICAgICAgICAgICAgIGhlYWRlclBhcmFtcy5wdXNoKG9iaik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChhcGlDb25maWdbJ3JlcXVlc3RCb2R5J10ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgcmVxdWVzdEJvZHkgPSBhcGlDb25maWdbJ3JlcXVlc3RCb2R5J107XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbWV0aG9kVHlwZSA9ICdQT1NUJztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLmNlZUFwaVNlcnZpY2UoXHJcbiAgICAgICAgICAgIGFwaUNvbmZpZ1sndXJsJ10sXHJcbiAgICAgICAgICAgIG1ldGhvZFR5cGUsXHJcbiAgICAgICAgICAgIGJvZHksXHJcbiAgICAgICAgICAgIHVybFBhcmFtcyxcclxuICAgICAgICAgICAgcXVlcnlQYXJhbXMsXHJcbiAgICAgICAgICAgIGhlYWRlclBhcmFtcyxcclxuICAgICAgICAgICAgcmVxdWVzdEJvZHkpO1xyXG4gICAgfVxyXG5cclxuXHQvKipcclxuXHQgKiBmdW5jdGlvbiByZXR1cm5zIHRlaCBmb3JtYXR0ZWQgYm9keSBpZiB0aGUgcmVxdWVzdEJvZHkga2V5IGluIHRoZVxyXG5cdCAqIGFwaSBjb25maWcgb2JqZWN0IGhhcyBhIGxlbmd0aCA+IDBcclxuXHQgKiBAcGFyYW0gYm9keU9ialxyXG5cdCAqIEBwYXJhbSBhcGlDb25maWdCb2R5QXJyXHJcblx0ICovXHJcbiAgICByZXR1cm5Gb3JtYXR0ZWRSZXF1ZXN0Qm9keShib2R5T2JqLCBhcGlDb25maWdCb2R5QXJyKSB7XHJcbiAgICAgICAgY29uc3QgZmxhdHRlbmRCb2R5ID0gdGhpcy5mbGF0VW5mbGF0LmZsYXR0ZW5KU09OKGJvZHlPYmopO1xyXG4gICAgICAgIGxldCBib2R5ID0ge307XHJcbiAgICAgICAgZm9yIChjb25zdCBzaW5nbGVrZXkgb2YgYXBpQ29uZmlnQm9keUFycikge1xyXG4gICAgICAgICAgICBpZiAoc2luZ2xla2V5LmluY2x1ZGVzKCcqJykpIHtcclxuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKHNpbmdsZWtleSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBtYXRjaGVkID0ge307XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZWdleCA9IHNpbmdsZWtleS5yZXBsYWNlKCdbKl0nLCAnXFxcXFtcXFxcZCtcXFxcXScpO1xyXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBmb3JpblxyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gZmxhdHRlbmRCb2R5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0ga2V5Lm1hdGNoKG5ldyBSZWdFeHAocmVnZXgpKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZWRba2V5XSA9IGZsYXR0ZW5kQm9keVtrZXldO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJvZHkgPSB7IC4uLmJvZHksIC4uLm1hdGNoZWQgfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChmbGF0dGVuZEJvZHkuaGFzT3duUHJvcGVydHkoc2luZ2xla2V5KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGJvZHlbc2luZ2xla2V5XSA9IGZsYXR0ZW5kQm9keVtzaW5nbGVrZXldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmZsYXRVbmZsYXQuY3JlYXRlTmVzdGVkT2JqZWN0KGJvZHkpO1xyXG4gICAgfVxyXG5cclxuXHQvKipcclxuXHQgKiBmdW5jdGlvbiB0aGF0IHdpbGwgaGl0IHRoZSBhcGlcclxuXHQgKiBOb3RlOiBmb3Igbm93IG9ubHkgYXBwbGljYXRpb24vanNvbiB0eXBlIGlzIHN1cHBvcnRlZFxyXG5cdCAqL1xyXG4gICAgY2VlQXBpU2VydmljZShcclxuICAgICAgICB1cmw6IHN0cmluZyxcclxuICAgICAgICBtZXRob2Q6IHN0cmluZyxcclxuICAgICAgICBib2R5OiBvYmplY3QsXHJcbiAgICAgICAgdXJsUGFyYW1zOiBBcnJheTxhbnk+LFxyXG4gICAgICAgIHF1ZXJ5UGFyYW1zOiBBcnJheTxhbnk+LFxyXG4gICAgICAgIGhlYWRlclBhcmFtczogQXJyYXk8YW55PixcclxuICAgICAgICBhcGlDb25maWdSZXF1ZXN0Qm9keTogQXJyYXk8YW55Pikge1xyXG4gICAgICAgIGNvbnN0IFVSTFBhcmFtID0gdXJsUGFyYW1zLmxlbmd0aCA+IDAgPyB1cmxQYXJhbXMuam9pbignLycpIDogJyc7XHJcbiAgICAgICAgY29uc3QgcXVlcnlQYXJhbSA9IHF1ZXJ5UGFyYW1zLm1hcCgoa2V5KSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhrZXkpLm1hcChkYXRhID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhICsgJz0nICsga2V5W2RhdGFdO1xyXG4gICAgICAgICAgICB9KVswXTtcclxuICAgICAgICB9KS5qb2luKCcmJyk7XHJcblxyXG4gICAgICAgIGxldCBoZWFkZXJzOiBIdHRwSGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xyXG4gICAgICAgIGhlYWRlcnMgPSBoZWFkZXJzLmFwcGVuZCgnQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcclxuICAgICAgICBoZWFkZXJQYXJhbXMuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhrZXkpLmZvckVhY2goZGF0YSA9PiB7XHJcbiAgICAgICAgICAgICAgICBoZWFkZXJzID0gaGVhZGVycy5hcHBlbmQoZGF0YSwga2V5W2RhdGFdKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHN3aXRjaCAobWV0aG9kKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ1BPU1QnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KFxyXG4gICAgICAgICAgICAgICAgICAgIHVybCArXHJcbiAgICAgICAgICAgICAgICAgICAgKFVSTFBhcmFtID8gJy8nICsgVVJMUGFyYW0gOiAnJykgK1xyXG4gICAgICAgICAgICAgICAgICAgIChxdWVyeVBhcmFtID8gJz8nICsgcXVlcnlQYXJhbSA6ICcnKSxcclxuICAgICAgICAgICAgICAgICAgICBhcGlDb25maWdSZXF1ZXN0Qm9keS5sZW5ndGggPiAwID8gdGhpcy5yZXR1cm5Gb3JtYXR0ZWRSZXF1ZXN0Qm9keShib2R5LCBhcGlDb25maWdSZXF1ZXN0Qm9keSkgOiBib2R5LFxyXG4gICAgICAgICAgICAgICAgICAgIHsgaGVhZGVycywgb2JzZXJ2ZTogJ3Jlc3BvbnNlJyB9KTtcclxuICAgICAgICAgICAgY2FzZSAnUFVUJzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHAucHV0KFxyXG4gICAgICAgICAgICAgICAgICAgIHVybCArXHJcbiAgICAgICAgICAgICAgICAgICAgKFVSTFBhcmFtID8gJy8nICsgVVJMUGFyYW0gOiAnJykgK1xyXG4gICAgICAgICAgICAgICAgICAgIChxdWVyeVBhcmFtID8gJz8nICsgcXVlcnlQYXJhbSA6ICcnKSxcclxuICAgICAgICAgICAgICAgICAgICBhcGlDb25maWdSZXF1ZXN0Qm9keS5sZW5ndGggPiAwID8gdGhpcy5yZXR1cm5Gb3JtYXR0ZWRSZXF1ZXN0Qm9keShib2R5LCBhcGlDb25maWdSZXF1ZXN0Qm9keSkgOiBib2R5LFxyXG4gICAgICAgICAgICAgICAgICAgIHsgaGVhZGVycywgb2JzZXJ2ZTogJ3Jlc3BvbnNlJyB9KTtcclxuICAgICAgICAgICAgY2FzZSAnR0VUJzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KFxyXG4gICAgICAgICAgICAgICAgICAgIHVybCArXHJcbiAgICAgICAgICAgICAgICAgICAgKFVSTFBhcmFtID8gJy8nICsgVVJMUGFyYW0gOiAnJykgK1xyXG4gICAgICAgICAgICAgICAgICAgIChxdWVyeVBhcmFtID8gJz8nICsgcXVlcnlQYXJhbSA6ICcnKSxcclxuICAgICAgICAgICAgICAgICAgICB7IGhlYWRlcnMsIG9ic2VydmU6ICdyZXNwb25zZScgfSk7XHJcbiAgICAgICAgICAgIGNhc2UgJ1BBVENIJzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHAucGF0Y2goXHJcbiAgICAgICAgICAgICAgICAgICAgdXJsICtcclxuICAgICAgICAgICAgICAgICAgICAoVVJMUGFyYW0gPyAnLycgKyBVUkxQYXJhbSA6ICcnKSArXHJcbiAgICAgICAgICAgICAgICAgICAgKHF1ZXJ5UGFyYW0gPyAnPycgKyBxdWVyeVBhcmFtIDogJycpLFxyXG4gICAgICAgICAgICAgICAgICAgIGFwaUNvbmZpZ1JlcXVlc3RCb2R5Lmxlbmd0aCA+IDAgPyB0aGlzLnJldHVybkZvcm1hdHRlZFJlcXVlc3RCb2R5KGJvZHksIGFwaUNvbmZpZ1JlcXVlc3RCb2R5KSA6IGJvZHksXHJcbiAgICAgICAgICAgICAgICAgICAgeyBoZWFkZXJzLCBvYnNlcnZlOiAncmVzcG9uc2UnIH0pO1xyXG4gICAgICAgICAgICBjYXNlICdERUxFVEUnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5kZWxldGUoXHJcbiAgICAgICAgICAgICAgICAgICAgdXJsICtcclxuICAgICAgICAgICAgICAgICAgICAoVVJMUGFyYW0gPyAnLycgKyBVUkxQYXJhbSA6ICcnKSArXHJcbiAgICAgICAgICAgICAgICAgICAgKHF1ZXJ5UGFyYW0gPyAnPycgKyBxdWVyeVBhcmFtIDogJycpLFxyXG4gICAgICAgICAgICAgICAgICAgIHsgaGVhZGVycywgb2JzZXJ2ZTogJ3Jlc3BvbnNlJyB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19