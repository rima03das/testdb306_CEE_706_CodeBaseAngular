export class CalculationUtil {
    //https://stackoverflow.com/questions/6479236/calculate-string-value-in-javascript-not-using-eval
    _symbols;
    constructor() {
        this._symbols = {};
        this.defineOperator("!", this.factorial, "postfix", 6);
        this.defineOperator("^", Math.pow, "infix", 5, true);
        this.defineOperator("*", this.multiplication, "infix", 4);
        this.defineOperator("/", this.division, "infix", 4);
        this.defineOperator("+", this.last, "prefix", 3);
        this.defineOperator("-", this.negation, "prefix", 3);
        this.defineOperator("+", this.addition, "infix", 2);
        this.defineOperator("-", this.subtraction, "infix", 2);
        this.defineOperator(",", Array.of, "infix", 1);
        this.defineOperator("(", this.last, "prefix");
        this.defineOperator(")", null, "postfix");
        this.defineOperator("min", Math.min);
        this.defineOperator("sqrt", Math.sqrt);
    }
    // Method allowing to extend an instance with more operators and functions:
    defineOperator(symbol, f, notation = "func", precedence = 0, rightToLeft = false) {
        // Store operators keyed by their symbol/name. Some symbols may represent
        // different usages: e.g. "-" can be unary or binary, so they are also
        // keyed by their notation (prefix, infix, postfix, func):
        if (notation === "func")
            precedence = 0;
        this._symbols[symbol] = Object.assign({}, this._symbols[symbol], {
            [notation]: {
                symbol, f, notation, precedence, rightToLeft,
                argCount: 1 + Number(notation === "infix")
            },
            symbol,
            regSymbol: symbol.replace(/[\\^$*+?.()|[\]{}]/g, '\\$&')
                + (/\w$/.test(symbol) ? "\\b" : "") // add a break if it's a name
        });
    }
    last(...a) { return a[a.length - 1]; }
    negation(a) { return -a; }
    addition(a, b) { return a + b; }
    subtraction(a, b) { return a - b; }
    multiplication(a, b) { return a * b; }
    division(a, b) { return a / b; }
    factorial(a) {
        if (a % 1 || !(+a >= 0))
            return NaN;
        if (a > 170)
            return Infinity;
        let b = 1;
        while (a > 1)
            b *= a--;
        return b;
    }
    calculate(expression) {
        expression = expression.replace(/\[/g, '(').replace(/\]/g, ')')
            .replace(/{/g, '(').replace(/}/g, ')');
        let match;
        const values = [], operators = [this._symbols["("].prefix], exec = () => {
            let op = operators.pop();
            values.push(op.f(...[].concat(...values.splice(-op.argCount))));
            return op.precedence;
        }, error = msg => {
            let notation = match ? match.index : expression.length;
            return `${msg} at ${notation}:\n${expression}\n${' '.repeat(notation)}^`;
        }, pattern = new RegExp(
        // Pattern for numbers
        "\\d+(?:\\.\\d+)?|"
            // ...and patterns for individual operators/function names
            + Object.values(this._symbols)
                // longer symbols should be listed first
                .sort((a, b) => b['symbol'].length - a['symbol'].length)
                .map(val => val['regSymbol']).join('|')
            + "|(\\S)", "g");
        let afterValue = false;
        pattern.lastIndex = 0; // Reset regular expression object
        do {
            match = pattern.exec(expression);
            const [token, bad] = match || [")", undefined], notNumber = this._symbols[token], notNewValue = notNumber && !notNumber.prefix && !notNumber.func, notAfterValue = !notNumber || !notNumber.postfix && !notNumber.infix;
            // Check for syntax errors:
            if (bad || (afterValue ? notAfterValue : notNewValue))
                return error("Syntax error");
            if (afterValue) {
                // We either have an infix or postfix operator (they should be mutually exclusive)
                const curr = notNumber.postfix || notNumber.infix;
                do {
                    const prev = operators[operators.length - 1];
                    if (((curr.precedence - prev.precedence) || prev.rightToLeft) > 0)
                        break;
                    // Apply previous operator, since it has precedence over current one
                } while (exec()); // Exit loop after executing an opening parenthesis or function
                afterValue = curr.notation === "postfix";
                if (curr.symbol !== ")") {
                    operators.push(curr);
                    // Postfix always has precedence over any operator that follows after it
                    if (afterValue)
                        exec();
                }
            }
            else if (notNumber) { // prefix operator or function
                operators.push(notNumber.prefix || notNumber.func);
                if (notNumber.func) { // Require an opening parenthesis
                    match = pattern.exec(expression);
                    if (!match || match[0] !== "(")
                        return error("Function needs parentheses");
                }
            }
            else { // number
                values.push(+token);
                afterValue = true;
            }
        } while (match && operators.length);
        return operators.length ? error("Missing closing parenthesis")
            : match ? error("Too many closing parentheses")
                : values.pop(); // All done!
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsY3VsYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9Bbmd1bGFyLTE3L0VTRi1Bbmd1bGFyLVdGRS1MaWJyYXJ5L3Byb2plY3RzL25nLWNlZS1jb3JlL3NyYy9saWIvdXRpbHMvY2FsY3VsYXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsTUFBTSxPQUFPLGVBQWU7SUFDeEIsaUdBQWlHO0lBQ2pHLFFBQVEsQ0FBQztJQUNUO1FBQ0ksSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxjQUFjLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzFELElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLElB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QyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUEsQ0FBQyxZQUFZO0lBQ3ZDLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5leHBvcnQgY2xhc3MgQ2FsY3VsYXRpb25VdGlsIHtcclxuICAgIC8vaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNjQ3OTIzNi9jYWxjdWxhdGUtc3RyaW5nLXZhbHVlLWluLWphdmFzY3JpcHQtbm90LXVzaW5nLWV2YWxcclxuICAgIF9zeW1ib2xzO1xyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5fc3ltYm9scyA9IHt9O1xyXG4gICAgICAgIHRoaXMuZGVmaW5lT3BlcmF0b3IoXCIhXCIsIHRoaXMuZmFjdG9yaWFsLCBcInBvc3RmaXhcIiwgNik7XHJcbiAgICAgICAgdGhpcy5kZWZpbmVPcGVyYXRvcihcIl5cIiwgTWF0aC5wb3csIFwiaW5maXhcIiwgNSwgdHJ1ZSk7XHJcbiAgICAgICAgdGhpcy5kZWZpbmVPcGVyYXRvcihcIipcIiwgdGhpcy5tdWx0aXBsaWNhdGlvbiwgXCJpbmZpeFwiLCA0KTtcclxuICAgICAgICB0aGlzLmRlZmluZU9wZXJhdG9yKFwiL1wiLCB0aGlzLmRpdmlzaW9uLCBcImluZml4XCIsIDQpO1xyXG4gICAgICAgIHRoaXMuZGVmaW5lT3BlcmF0b3IoXCIrXCIsIHRoaXMubGFzdCwgXCJwcmVmaXhcIiwgMyk7XHJcbiAgICAgICAgdGhpcy5kZWZpbmVPcGVyYXRvcihcIi1cIiwgdGhpcy5uZWdhdGlvbiwgXCJwcmVmaXhcIiwgMyk7XHJcbiAgICAgICAgdGhpcy5kZWZpbmVPcGVyYXRvcihcIitcIiwgdGhpcy5hZGRpdGlvbiwgXCJpbmZpeFwiLCAyKTtcclxuICAgICAgICB0aGlzLmRlZmluZU9wZXJhdG9yKFwiLVwiLCB0aGlzLnN1YnRyYWN0aW9uLCBcImluZml4XCIsIDIpO1xyXG4gICAgICAgIHRoaXMuZGVmaW5lT3BlcmF0b3IoXCIsXCIsIEFycmF5Lm9mLCBcImluZml4XCIsIDEpO1xyXG4gICAgICAgIHRoaXMuZGVmaW5lT3BlcmF0b3IoXCIoXCIsIHRoaXMubGFzdCwgXCJwcmVmaXhcIik7XHJcbiAgICAgICAgdGhpcy5kZWZpbmVPcGVyYXRvcihcIilcIiwgbnVsbCwgXCJwb3N0Zml4XCIpO1xyXG4gICAgICAgIHRoaXMuZGVmaW5lT3BlcmF0b3IoXCJtaW5cIiwgTWF0aC5taW4pO1xyXG4gICAgICAgIHRoaXMuZGVmaW5lT3BlcmF0b3IoXCJzcXJ0XCIsIE1hdGguc3FydCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gTWV0aG9kIGFsbG93aW5nIHRvIGV4dGVuZCBhbiBpbnN0YW5jZSB3aXRoIG1vcmUgb3BlcmF0b3JzIGFuZCBmdW5jdGlvbnM6XHJcbiAgICBkZWZpbmVPcGVyYXRvcihzeW1ib2wsIGYsIG5vdGF0aW9uID0gXCJmdW5jXCIsIHByZWNlZGVuY2UgPSAwLCByaWdodFRvTGVmdCA9IGZhbHNlKSB7XHJcbiAgICAgICAgLy8gU3RvcmUgb3BlcmF0b3JzIGtleWVkIGJ5IHRoZWlyIHN5bWJvbC9uYW1lLiBTb21lIHN5bWJvbHMgbWF5IHJlcHJlc2VudFxyXG4gICAgICAgIC8vIGRpZmZlcmVudCB1c2FnZXM6IGUuZy4gXCItXCIgY2FuIGJlIHVuYXJ5IG9yIGJpbmFyeSwgc28gdGhleSBhcmUgYWxzb1xyXG4gICAgICAgIC8vIGtleWVkIGJ5IHRoZWlyIG5vdGF0aW9uIChwcmVmaXgsIGluZml4LCBwb3N0Zml4LCBmdW5jKTpcclxuICAgICAgICBpZiAobm90YXRpb24gPT09IFwiZnVuY1wiKSBwcmVjZWRlbmNlID0gMDtcclxuICAgICAgICB0aGlzLl9zeW1ib2xzW3N5bWJvbF0gPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLl9zeW1ib2xzW3N5bWJvbF0sIHtcclxuICAgICAgICAgICAgW25vdGF0aW9uXToge1xyXG4gICAgICAgICAgICAgICAgc3ltYm9sLCBmLCBub3RhdGlvbiwgcHJlY2VkZW5jZSwgcmlnaHRUb0xlZnQsXHJcbiAgICAgICAgICAgICAgICBhcmdDb3VudDogMSArIE51bWJlcihub3RhdGlvbiA9PT0gXCJpbmZpeFwiKVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzeW1ib2wsXHJcbiAgICAgICAgICAgIHJlZ1N5bWJvbDogc3ltYm9sLnJlcGxhY2UoL1tcXFxcXiQqKz8uKCl8W1xcXXt9XS9nLCAnXFxcXCQmJylcclxuICAgICAgICAgICAgICAgICsgKC9cXHckLy50ZXN0KHN5bWJvbCkgPyBcIlxcXFxiXCIgOiBcIlwiKSAvLyBhZGQgYSBicmVhayBpZiBpdCdzIGEgbmFtZVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgbGFzdCguLi5hKSB7IHJldHVybiBhW2EubGVuZ3RoIC0gMV0gfVxyXG4gICAgbmVnYXRpb24oYSkgeyByZXR1cm4gLWEgfVxyXG4gICAgYWRkaXRpb24oYSwgYikgeyByZXR1cm4gYSArIGIgfVxyXG4gICAgc3VidHJhY3Rpb24oYSwgYikgeyByZXR1cm4gYSAtIGIgfVxyXG4gICAgbXVsdGlwbGljYXRpb24oYSwgYikgeyByZXR1cm4gYSAqIGIgfVxyXG4gICAgZGl2aXNpb24oYSwgYikgeyByZXR1cm4gYSAvIGIgfVxyXG4gICAgZmFjdG9yaWFsKGEpIHtcclxuICAgICAgICBpZiAoYSAlIDEgfHwgISgrYSA+PSAwKSkgcmV0dXJuIE5hTlxyXG4gICAgICAgIGlmIChhID4gMTcwKSByZXR1cm4gSW5maW5pdHk7XHJcbiAgICAgICAgbGV0IGIgPSAxO1xyXG4gICAgICAgIHdoaWxlIChhID4gMSkgYiAqPSBhLS07XHJcbiAgICAgICAgcmV0dXJuIGI7XHJcbiAgICB9XHJcbiAgICBjYWxjdWxhdGUoZXhwcmVzc2lvbikge1xyXG4gICAgICAgIGV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2UoL1xcWy9nLCAnKCcpLnJlcGxhY2UoL1xcXS9nLCAnKScpXHJcbiAgICAgICAgLnJlcGxhY2UoL3svZywgJygnKS5yZXBsYWNlKC99L2csICcpJyk7XHJcbiAgICAgICAgbGV0IG1hdGNoO1xyXG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IFtdLFxyXG4gICAgICAgICAgICBvcGVyYXRvcnMgPSBbdGhpcy5fc3ltYm9sc1tcIihcIl0ucHJlZml4XSxcclxuICAgICAgICAgICAgZXhlYyA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCBvcCA9IG9wZXJhdG9ycy5wb3AoKTtcclxuICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKG9wLmYoLi4uW10uY29uY2F0KC4uLnZhbHVlcy5zcGxpY2UoLW9wLmFyZ0NvdW50KSkpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBvcC5wcmVjZWRlbmNlO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBlcnJvciA9IG1zZyA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbm90YXRpb24gPSBtYXRjaCA/IG1hdGNoLmluZGV4IDogZXhwcmVzc2lvbi5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYCR7bXNnfSBhdCAke25vdGF0aW9ufTpcXG4ke2V4cHJlc3Npb259XFxuJHsnICcucmVwZWF0KG5vdGF0aW9uKX1eYDtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcGF0dGVybiA9IG5ldyBSZWdFeHAoXHJcbiAgICAgICAgICAgICAgICAvLyBQYXR0ZXJuIGZvciBudW1iZXJzXHJcbiAgICAgICAgICAgICAgICBcIlxcXFxkKyg/OlxcXFwuXFxcXGQrKT98XCJcclxuICAgICAgICAgICAgICAgIC8vIC4uLmFuZCBwYXR0ZXJucyBmb3IgaW5kaXZpZHVhbCBvcGVyYXRvcnMvZnVuY3Rpb24gbmFtZXNcclxuICAgICAgICAgICAgICAgICsgT2JqZWN0LnZhbHVlcyh0aGlzLl9zeW1ib2xzKVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGxvbmdlciBzeW1ib2xzIHNob3VsZCBiZSBsaXN0ZWQgZmlyc3RcclxuICAgICAgICAgICAgICAgICAgICAuc29ydCgoYSwgYikgPT4gYlsnc3ltYm9sJ10ubGVuZ3RoIC0gYVsnc3ltYm9sJ10ubGVuZ3RoKVxyXG4gICAgICAgICAgICAgICAgICAgIC5tYXAodmFsID0+IHZhbFsncmVnU3ltYm9sJ10pLmpvaW4oJ3wnKVxyXG4gICAgICAgICAgICAgICAgKyBcInwoXFxcXFMpXCIsIFwiZ1wiXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgbGV0IGFmdGVyVmFsdWUgPSBmYWxzZTtcclxuICAgICAgICBwYXR0ZXJuLmxhc3RJbmRleCA9IDA7IC8vIFJlc2V0IHJlZ3VsYXIgZXhwcmVzc2lvbiBvYmplY3RcclxuICAgICAgICBkbyB7XHJcbiAgICAgICAgICAgIG1hdGNoID0gcGF0dGVybi5leGVjKGV4cHJlc3Npb24pO1xyXG4gICAgICAgICAgICBjb25zdCBbdG9rZW4sIGJhZF0gPSBtYXRjaCB8fCBbXCIpXCIsIHVuZGVmaW5lZF0sXHJcbiAgICAgICAgICAgICAgICBub3ROdW1iZXIgPSB0aGlzLl9zeW1ib2xzW3Rva2VuXSxcclxuICAgICAgICAgICAgICAgIG5vdE5ld1ZhbHVlID0gbm90TnVtYmVyICYmICFub3ROdW1iZXIucHJlZml4ICYmICFub3ROdW1iZXIuZnVuYyxcclxuICAgICAgICAgICAgICAgIG5vdEFmdGVyVmFsdWUgPSAhbm90TnVtYmVyIHx8ICFub3ROdW1iZXIucG9zdGZpeCAmJiAhbm90TnVtYmVyLmluZml4O1xyXG4gICAgICAgICAgICAvLyBDaGVjayBmb3Igc3ludGF4IGVycm9yczpcclxuICAgICAgICAgICAgaWYgKGJhZCB8fCAoYWZ0ZXJWYWx1ZSA/IG5vdEFmdGVyVmFsdWUgOiBub3ROZXdWYWx1ZSkpIHJldHVybiBlcnJvcihcIlN5bnRheCBlcnJvclwiKTtcclxuICAgICAgICAgICAgaWYgKGFmdGVyVmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIC8vIFdlIGVpdGhlciBoYXZlIGFuIGluZml4IG9yIHBvc3RmaXggb3BlcmF0b3IgKHRoZXkgc2hvdWxkIGJlIG11dHVhbGx5IGV4Y2x1c2l2ZSlcclxuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnIgPSBub3ROdW1iZXIucG9zdGZpeCB8fCBub3ROdW1iZXIuaW5maXg7XHJcbiAgICAgICAgICAgICAgICBkbyB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJldiA9IG9wZXJhdG9yc1tvcGVyYXRvcnMubGVuZ3RoIC0gMV07XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCgoY3Vyci5wcmVjZWRlbmNlIC0gcHJldi5wcmVjZWRlbmNlKSB8fCBwcmV2LnJpZ2h0VG9MZWZ0KSA+IDApIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEFwcGx5IHByZXZpb3VzIG9wZXJhdG9yLCBzaW5jZSBpdCBoYXMgcHJlY2VkZW5jZSBvdmVyIGN1cnJlbnQgb25lXHJcbiAgICAgICAgICAgICAgICB9IHdoaWxlIChleGVjKCkpOyAvLyBFeGl0IGxvb3AgYWZ0ZXIgZXhlY3V0aW5nIGFuIG9wZW5pbmcgcGFyZW50aGVzaXMgb3IgZnVuY3Rpb25cclxuICAgICAgICAgICAgICAgIGFmdGVyVmFsdWUgPSBjdXJyLm5vdGF0aW9uID09PSBcInBvc3RmaXhcIjtcclxuICAgICAgICAgICAgICAgIGlmIChjdXJyLnN5bWJvbCAhPT0gXCIpXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICBvcGVyYXRvcnMucHVzaChjdXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBQb3N0Zml4IGFsd2F5cyBoYXMgcHJlY2VkZW5jZSBvdmVyIGFueSBvcGVyYXRvciB0aGF0IGZvbGxvd3MgYWZ0ZXIgaXRcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYWZ0ZXJWYWx1ZSkgZXhlYygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKG5vdE51bWJlcikgeyAvLyBwcmVmaXggb3BlcmF0b3Igb3IgZnVuY3Rpb25cclxuICAgICAgICAgICAgICAgIG9wZXJhdG9ycy5wdXNoKG5vdE51bWJlci5wcmVmaXggfHwgbm90TnVtYmVyLmZ1bmMpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vdE51bWJlci5mdW5jKSB7IC8vIFJlcXVpcmUgYW4gb3BlbmluZyBwYXJlbnRoZXNpc1xyXG4gICAgICAgICAgICAgICAgICAgIG1hdGNoID0gcGF0dGVybi5leGVjKGV4cHJlc3Npb24pO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghbWF0Y2ggfHwgbWF0Y2hbMF0gIT09IFwiKFwiKSByZXR1cm4gZXJyb3IoXCJGdW5jdGlvbiBuZWVkcyBwYXJlbnRoZXNlc1wiKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgeyAvLyBudW1iZXJcclxuICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKCt0b2tlbik7XHJcbiAgICAgICAgICAgICAgICBhZnRlclZhbHVlID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gd2hpbGUgKG1hdGNoICYmIG9wZXJhdG9ycy5sZW5ndGgpO1xyXG4gICAgICAgIHJldHVybiBvcGVyYXRvcnMubGVuZ3RoID8gZXJyb3IoXCJNaXNzaW5nIGNsb3NpbmcgcGFyZW50aGVzaXNcIilcclxuICAgICAgICAgICAgOiBtYXRjaCA/IGVycm9yKFwiVG9vIG1hbnkgY2xvc2luZyBwYXJlbnRoZXNlc1wiKVxyXG4gICAgICAgICAgICAgICAgOiB2YWx1ZXMucG9wKCkgLy8gQWxsIGRvbmUhXHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==