import { APIKeyUtil } from './api-key-util';
import { FlatUnflat } from './flat-unflat-json';
import { CommonUtil } from './common-util';
import { Injectable } from '@angular/core';
import * as i0 from "@angular/core";
import * as i1 from "../models/api-data/api-data.service";
import * as i2 from "../models/app-data/app-data.service";
export class SetAPICallbackData {
    apiDataService;
    appDataService;
    apiKeyUtil;
    flatAndNestUtil;
    commonUtil;
    constructor(apiDataService, appDataService) {
        this.apiDataService = apiDataService;
        this.appDataService = appDataService;
        this.apiKeyUtil = new APIKeyUtil();
        this.flatAndNestUtil = new FlatUnflat(appDataService);
        this.commonUtil = new CommonUtil();
    }
    // TODO : Handle when data is undefined
    setApiCallBackData(fieldData, data) {
        let apiData;
        if (data) {
            if (typeof (fieldData) === 'string' || (this.isSingleApiKey && fieldData.api_key)) {
                const apiKey = typeof (fieldData) === 'string' ? fieldData : fieldData.api_key;
                if (this.isHashedApiKey) {
                    // this will only work if hashed api key is set and that is set if the api_type in app_config.json is
                    // set to EXTERNAL or INTERNAL
                    apiData = apiKey && apiKey.includes('##') ?
                        this.commonUtil.getHandlerName(apiKey) === data.handler_name ?
                            this.getAPIData(data, apiKey) : undefined : this.getAPIData(data, apiKey);
                }
                else {
                    apiData = data[apiKey];
                }
            }
            else if (fieldData && fieldData.response_api_key) {
                // TODO: check the functionality
                // check for the api key first
                if (fieldData.response_api_key.includes('|')) {
                    // set multiple field values
                    const apiKeys = this.apiKeyUtil.getMultipleApiKeys(this.apiKeyUtil.getConcatenatedApiKeys(fieldData.response_api_key));
                    for (const key of apiKeys) {
                        if (key.includes('+')) {
                            let value;
                            const keys = key.split('+');
                            for (const singleKey of keys) {
                                let isHashed = false;
                                isHashed = singleKey.includes('##') ?
                                    this.commonUtil.getHandlerName(singleKey) === data.handler_name ? true : false : true;
                                if (isHashed) {
                                    value = keys.indexOf(singleKey) === 0 ?
                                        this.getAPIData(data, singleKey) :
                                        value + ' ' + this.getAPIData(data, singleKey);
                                }
                            }
                            apiData = value;
                        }
                        else {
                            const getAPIValue = key.includes('##') ?
                                (this.commonUtil.getHandlerName(key) === data.handler_name) ? this.getAPIData(data, key) :
                                    undefined : this.getAPIData(data, key);
                            if (getAPIValue !== undefined) {
                                apiData = getAPIValue;
                            }
                        }
                    }
                }
                else {
                    const getAPIValue = fieldData.response_api_key.includes('##') ?
                        ((this.commonUtil.getHandlerName(fieldData.response_api_key) === data.handler_name) ?
                            this.getAPIData(data, fieldData.response_api_key) :
                            undefined) : this.getAPIData(data, fieldData.response_api_key);
                    if (getAPIValue !== undefined) {
                        apiData = getAPIValue;
                    }
                }
            }
        }
        if (fieldData && fieldData.additional_parameters) {
            const checkSkipBlankAPiField = fieldData.additional_parameters.find(i => i.parameter_type === 'skip_blank_api_data' && i.value === 'true');
            if (checkSkipBlankAPiField && !apiData) {
                const defaultValue = fieldData.additional_parameters.find(i => i.parameter_type === 'default_value');
                if (defaultValue) {
                    apiData = defaultValue.value;
                }
            }
        }
        if (apiData !== undefined) {
            return apiData;
        }
        else {
            return null;
        }
    }
    /**
     * function that returns the value according to the api key
     * @param data the data from the api
     * @param apiKey the key from where the data is retrieved
     */
    getAPIData(data, apiKey) {
        if (data[apiKey] || this.isSingleApiKey) {
            return (data[apiKey]);
        }
        else {
            if (apiKey.includes('[*]')) {
                const arr = apiKey.split('[*]');
                if (arr[1] !== '') {
                    const regex = apiKey.replaceAll('[', '\\[').replaceAll(']', '\\]').replaceAll('\\[*\\]', '\\[\\d+\\]');
                    const array = [];
                    for (const key of Object.keys(data)) {
                        const result = key.match(new RegExp(regex));
                        const lastKey = key && key.includes('.') && key.split('.').length > 0 ? key.split('.')[key.split('.').length - 1] : key;
                        const lastRegex = regex && regex.includes('.') && regex.split('.').length > 0 ? regex.split('.')[regex.split('.').length - 1] : regex;
                        if (result && lastKey == lastRegex) {
                            array.push(data[result[0]]);
                        }
                    }
                    return (array.length <= 0 ? undefined : array);
                }
                else {
                    return (this.getArrayWithIndex(data, arr[0]));
                }
            }
            else {
                return (this.getArrayWithIndex(data, apiKey));
            }
        }
    }
    getArrayWithIndex(apiData, apiKey) {
        try {
            let result = this.flatAndNestUtil.createNestedObject(apiData);
            const arr = apiKey.split('.');
            let data;
            for (const singleKey of arr) {
                const regex = singleKey.match(new RegExp(/(?:\[)(\d+)(?:\])/g));
                if (regex) {
                    // const index = Number(regex.slice(1, (regex.length - 1)).join());
                    const index = Number(regex[0].replace('[', '').replace(']', ''));
                    data = arr.indexOf(singleKey) === 0
                        ? typeof (result) === 'object' ? result[singleKey.split(regex.join(''))[0]][index] : result[index]
                        : result[singleKey.split(regex.join(''))[0]][index];
                }
                else {
                    data = result[singleKey];
                }
                result = data;
            }
            return data;
        }
        catch (error) {
            return undefined;
        }
    }
    /**
     * function the data in the api store using the handler name
     * @param keyName can be a string
     */
    returnValueFromApiStoreUsingHandlerName(keyName) {
        const handlerValue = this.apiDataService.getApiDataByHandler(this.commonUtil.getHandlerName(keyName)) ?
            this.apiDataService.getApiDataByHandler(this.commonUtil.getHandlerName(keyName)).value : {};
        return handlerValue;
    }
    // all getter setters goes here
    get isSingleApiKey() {
        return localStorage.getItem('singleApiKey') === 'true' ? true : false;
    }
    get isHashedApiKey() {
        return localStorage.getItem('hash_api_key') === 'true' ? true : false;
    }
    static ɵfac = function SetAPICallbackData_Factory(t) { return new (t || SetAPICallbackData)(i0.ɵɵinject(i1.ApiDataService), i0.ɵɵinject(i2.AppDataService)); };
    static ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: SetAPICallbackData, factory: SetAPICallbackData.ɵfac, providedIn: 'root' });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(SetAPICallbackData, [{
        type: Injectable,
        args: [{
                providedIn: 'root',
            }]
    }], () => [{ type: i1.ApiDataService }, { type: i2.AppDataService }], null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0LWFwaS1jYWxsYmFjay1kYXRhLXV0aWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9Bbmd1bGFyLTE3L0VTRi1Bbmd1bGFyLVdGRS1MaWJyYXJ5L3Byb2plY3RzL25nLWNlZS1jb3JlL3NyYy9saWIvdXRpbHMvc2V0LWFwaS1jYWxsYmFjay1kYXRhLXV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUdoRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7Ozs7QUFJM0MsTUFBTSxPQUFPLGtCQUFrQjtJQUtoQjtJQUNBO0lBTEgsVUFBVSxDQUFhO0lBQ3ZCLGVBQWUsQ0FBYTtJQUM1QixVQUFVLENBQWE7SUFDL0IsWUFDVyxjQUE4QixFQUM5QixjQUErQjtRQUQvQixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsbUJBQWMsR0FBZCxjQUFjLENBQWlCO1FBQ3RDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQztRQUNuQyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3RELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQztJQUN2QyxDQUFDO0lBRUQsdUNBQXVDO0lBQ3ZDLGtCQUFrQixDQUFDLFNBQVMsRUFBRSxJQUFJO1FBQzlCLElBQUksT0FBWSxDQUFDO1FBQ2pCLElBQUksSUFBSSxFQUFFO1lBQ04sSUFBSSxPQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsSUFBSSxTQUFTLENBQUMsT0FBTyxDQUFDLEVB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Q0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ3BHLE9BQU8sWUFBWSxDQUFDO0lBQ3hCLENBQUM7SUFFRCwrQkFBK0I7SUFDL0IsSUFBSSxjQUFjO1FBQ2QsT0FBTyxZQUFZLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7SUFDMUUsQ0FBQztJQUVELElBQUksY0FBYztRQUNkLE9BQU8sWUFBWSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0lBQzFFLENBQUM7NEVBaktRLGtCQUFrQjtnRUFBbEIsa0JBQWtCLFdBQWxCLGtCQUFrQixtQkFGZixNQUFNOztpRkFFVCxrQkFBa0I7Y0FIOUIsVUFBVTtlQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJS2V5VXRpbCB9IGZyb20gJy4vYXBpLWtleS11dGlsJztcclxuaW1wb3J0IHsgRmxhdFVuZmxhdCB9IGZyb20gJy4vZmxhdC11bmZsYXQtanNvbic7XHJcbmltcG9ydCB7IEFwcERhdGFTZXJ2aWNlIH0gZnJvbSAnLi4vbW9kZWxzL2FwcC1kYXRhL2FwcC1kYXRhLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBBcGlEYXRhU2VydmljZSB9IGZyb20gJy4uL21vZGVscy9hcGktZGF0YS9hcGktZGF0YS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ29tbW9uVXRpbCB9IGZyb20gJy4vY29tbW9uLXV0aWwnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46ICdyb290JyxcclxufSlcclxuZXhwb3J0IGNsYXNzIFNldEFQSUNhbGxiYWNrRGF0YSB7XHJcbiAgICBwcml2YXRlIGFwaUtleVV0aWw6IEFQSUtleVV0aWw7XHJcbiAgICBwcml2YXRlIGZsYXRBbmROZXN0VXRpbDogRmxhdFVuZmxhdDtcclxuICAgIHByaXZhdGUgY29tbW9uVXRpbDogQ29tbW9uVXRpbDtcclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHB1YmxpYyBhcGlEYXRhU2VydmljZTogQXBpRGF0YVNlcnZpY2UsXHJcbiAgICAgICAgcHVibGljIGFwcERhdGFTZXJ2aWNlPzogQXBwRGF0YVNlcnZpY2UpIHtcclxuICAgICAgICB0aGlzLmFwaUtleVV0aWwgPSBuZXcgQVBJS2V5VXRpbCgpO1xyXG4gICAgICAgIHRoaXMuZmxhdEFuZE5lc3RVdGlsID0gbmV3IEZsYXRVbmZsYXQoYXBwRGF0YVNlcnZpY2UpO1xyXG4gICAgICAgIHRoaXMuY29tbW9uVXRpbCA9IG5ldyBDb21tb25VdGlsKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVE9ETyA6IEhhbmRsZSB3aGVuIGRhdGEgaXMgdW5kZWZpbmVkXHJcbiAgICBzZXRBcGlDYWxsQmFja0RhdGEoZmllbGREYXRhLCBkYXRhKSB7XHJcbiAgICAgICAgbGV0IGFwaURhdGE6IGFueTtcclxuICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIChmaWVsZERhdGEpID09PSAnc3RyaW5nJyB8fCAodGhpcy5pc1NpbmdsZUFwaUtleSAmJiBmaWVsZERhdGEuYXBpX2tleSkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFwaUtleSA9IHR5cGVvZiAoZmllbGREYXRhKSA9PT0gJ3N0cmluZycgPyBmaWVsZERhdGEgOiBmaWVsZERhdGEuYXBpX2tleTtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzSGFzaGVkQXBpS2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyB3aWxsIG9ubHkgd29yayBpZiBoYXNoZWQgYXBpIGtleSBpcyBzZXQgYW5kIHRoYXQgaXMgc2V0IGlmIHRoZSBhcGlfdHlwZSBpbiBhcHBfY29uZmlnLmpzb24gaXNcclxuICAgICAgICAgICAgICAgICAgICAvLyBzZXQgdG8gRVhURVJOQUwgb3IgSU5URVJOQUxcclxuICAgICAgICAgICAgICAgICAgICBhcGlEYXRhID0gYXBpS2V5ICYmIGFwaUtleS5pbmNsdWRlcygnIyMnKSA/XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29tbW9uVXRpbC5nZXRIYW5kbGVyTmFtZShhcGlLZXkpID09PSBkYXRhLmhhbmRsZXJfbmFtZSA/XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldEFQSURhdGEoZGF0YSwgYXBpS2V5KSA6IHVuZGVmaW5lZCA6IHRoaXMuZ2V0QVBJRGF0YShkYXRhLCBhcGlLZXkpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBhcGlEYXRhID0gZGF0YVthcGlLZXldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZpZWxkRGF0YSAmJiBmaWVsZERhdGEucmVzcG9uc2VfYXBpX2tleSkge1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogY2hlY2sgdGhlIGZ1bmN0aW9uYWxpdHlcclxuICAgICAgICAgICAgICAgIC8vIGNoZWNrIGZvciB0aGUgYXBpIGtleSBmaXJzdFxyXG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkRGF0YS5yZXNwb25zZV9hcGlfa2V5LmluY2x1ZGVzKCd8JykpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBzZXQgbXVsdGlwbGUgZmllbGQgdmFsdWVzXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXBpS2V5cyA9IHRoaXMuYXBpS2V5VXRpbC5nZXRNdWx0aXBsZUFwaUtleXModGhpcy5hcGlLZXlVdGlsLmdldENvbmNhdGVuYXRlZEFwaUtleXMoZmllbGREYXRhLnJlc3BvbnNlX2FwaV9rZXkpKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBhcGlLZXlzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkuaW5jbHVkZXMoJysnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5cyA9IGtleS5zcGxpdCgnKycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBzaW5nbGVLZXkgb2Yga2V5cykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpc0hhc2hlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzSGFzaGVkID0gc2luZ2xlS2V5LmluY2x1ZGVzKCcjIycpID9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21tb25VdGlsLmdldEhhbmRsZXJOYW1lKHNpbmdsZUtleSkgPT09IGRhdGEuaGFuZGxlcl9uYW1lID8gdHJ1ZSA6IGZhbHNlIDogdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNIYXNoZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBrZXlzLmluZGV4T2Yoc2luZ2xlS2V5KSA9PT0gMCA/XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldEFQSURhdGEoZGF0YSwgc2luZ2xlS2V5KSA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSArICcgJyArIHRoaXMuZ2V0QVBJRGF0YShkYXRhLCBzaW5nbGVLZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwaURhdGEgPSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdldEFQSVZhbHVlID0ga2V5LmluY2x1ZGVzKCcjIycpID9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGhpcy5jb21tb25VdGlsLmdldEhhbmRsZXJOYW1lKGtleSkgPT09IGRhdGEuaGFuZGxlcl9uYW1lKSA/IHRoaXMuZ2V0QVBJRGF0YShkYXRhLCBrZXkpIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5kZWZpbmVkIDogdGhpcy5nZXRBUElEYXRhKGRhdGEsIGtleSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ2V0QVBJVmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwaURhdGEgPSBnZXRBUElWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGdldEFQSVZhbHVlID0gZmllbGREYXRhLnJlc3BvbnNlX2FwaV9rZXkuaW5jbHVkZXMoJyMjJykgP1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAoKHRoaXMuY29tbW9uVXRpbC5nZXRIYW5kbGVyTmFtZShmaWVsZERhdGEucmVzcG9uc2VfYXBpX2tleSkgPT09IGRhdGEuaGFuZGxlcl9uYW1lKSA/XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldEFQSURhdGEoZGF0YSwgZmllbGREYXRhLnJlc3BvbnNlX2FwaV9rZXkpIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZCkgOiB0aGlzLmdldEFQSURhdGEoZGF0YSwgZmllbGREYXRhLnJlc3BvbnNlX2FwaV9rZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChnZXRBUElWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwaURhdGEgPSBnZXRBUElWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGZpZWxkRGF0YSAmJiBmaWVsZERhdGEuYWRkaXRpb25hbF9wYXJhbWV0ZXJzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoZWNrU2tpcEJsYW5rQVBpRmllbGQgPSBmaWVsZERhdGEuYWRkaXRpb25hbF9wYXJhbWV0ZXJzLmZpbmQoaSA9PiBpLnBhcmFtZXRlcl90eXBlID09PSAnc2tpcF9ibGFua19hcGlfZGF0YScgJiYgaS52YWx1ZSA9PT0gJ3RydWUnKTtcclxuICAgICAgICAgICAgaWYgKGNoZWNrU2tpcEJsYW5rQVBpRmllbGQgJiYgIWFwaURhdGEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRWYWx1ZSA9IGZpZWxkRGF0YS5hZGRpdGlvbmFsX3BhcmFtZXRlcnMuZmluZChpID0+IGkucGFyYW1ldGVyX3R5cGUgPT09ICdkZWZhdWx0X3ZhbHVlJyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXBpRGF0YSA9IGRlZmF1bHRWYWx1ZS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoYXBpRGF0YSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhcGlEYXRhO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgdmFsdWUgYWNjb3JkaW5nIHRvIHRoZSBhcGkga2V5XHJcbiAgICAgKiBAcGFyYW0gZGF0YSB0aGUgZGF0YSBmcm9tIHRoZSBhcGlcclxuICAgICAqIEBwYXJhbSBhcGlLZXkgdGhlIGtleSBmcm9tIHdoZXJlIHRoZSBkYXRhIGlzIHJldHJpZXZlZFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGdldEFQSURhdGEoZGF0YSwgYXBpS2V5KSB7XHJcbiAgICAgICAgaWYgKGRhdGFbYXBpS2V5XSB8fCB0aGlzLmlzU2luZ2xlQXBpS2V5KSB7XHJcbiAgICAgICAgICAgIHJldHVybiAoZGF0YVthcGlLZXldKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoYXBpS2V5LmluY2x1ZGVzKCdbKl0nKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXJyID0gYXBpS2V5LnNwbGl0KCdbKl0nKTtcclxuICAgICAgICAgICAgICAgIGlmIChhcnJbMV0gIT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVnZXggPSBhcGlLZXkucmVwbGFjZUFsbCgnWycsICdcXFxcWycpLnJlcGxhY2VBbGwoJ10nLCAnXFxcXF0nKS5yZXBsYWNlQWxsKCdcXFxcWypcXFxcXScsICdcXFxcW1xcXFxkK1xcXFxdJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXJyYXkgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhkYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBrZXkubWF0Y2gobmV3IFJlZ0V4cChyZWdleCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0S2V5ID0ga2V5ICYmIGtleS5pbmNsdWRlcygnLicpICYmIGtleS5zcGxpdCgnLicpLmxlbmd0aCA+IDAgPyBrZXkuc3BsaXQoJy4nKVtrZXkuc3BsaXQoJy4nKS5sZW5ndGggLSAxXSA6IGtleTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFzdFJlZ2V4ID0gcmVnZXggJiYgcmVnZXguaW5jbHVkZXMoJy4nKSAmJiByZWdleC5zcGxpdCgnLicpLmxlbmd0aCA+IDAgPyByZWdleC5zcGxpdCgnLicpW3JlZ2V4LnNwbGl0KCcuJykubGVuZ3RoIC0gMV0gOiByZWdleDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCAmJiBsYXN0S2V5ID09IGxhc3RSZWdleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChkYXRhW3Jlc3VsdFswXV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAoYXJyYXkubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcnJheSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5nZXRBcnJheVdpdGhJbmRleChkYXRhLCBhcnJbMF0pKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5nZXRBcnJheVdpdGhJbmRleChkYXRhLCBhcGlLZXkpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0QXJyYXlXaXRoSW5kZXgoYXBpRGF0YSwgYXBpS2V5KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHRoaXMuZmxhdEFuZE5lc3RVdGlsLmNyZWF0ZU5lc3RlZE9iamVjdChhcGlEYXRhKTtcclxuICAgICAgICAgICAgY29uc3QgYXJyID0gYXBpS2V5LnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgIGxldCBkYXRhOiBhbnk7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3Qgc2luZ2xlS2V5IG9mIGFycikge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVnZXggPSBzaW5nbGVLZXkubWF0Y2gobmV3IFJlZ0V4cCgvKD86XFxbKShcXGQrKSg/OlxcXSkvZykpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlZ2V4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc3QgaW5kZXggPSBOdW1iZXIocmVnZXguc2xpY2UoMSwgKHJlZ2V4Lmxlbmd0aCAtIDEpKS5qb2luKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gTnVtYmVyKHJlZ2V4WzBdLnJlcGxhY2UoJ1snLCAnJykucmVwbGFjZSgnXScsICcnKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGFyci5pbmRleE9mKHNpbmdsZUtleSkgPT09IDBcclxuICAgICAgICAgICAgICAgICAgICAgICAgPyB0eXBlb2YgKHJlc3VsdCkgPT09ICdvYmplY3QnID8gcmVzdWx0W3NpbmdsZUtleS5zcGxpdChyZWdleC5qb2luKCcnKSlbMF1dW2luZGV4XSA6IHJlc3VsdFtpbmRleF1cclxuICAgICAgICAgICAgICAgICAgICAgICAgOiByZXN1bHRbc2luZ2xlS2V5LnNwbGl0KHJlZ2V4LmpvaW4oJycpKVswXV1baW5kZXhdO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhID0gcmVzdWx0W3NpbmdsZUtleV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBkYXRhO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBkYXRhO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBmdW5jdGlvbiB0aGUgZGF0YSBpbiB0aGUgYXBpIHN0b3JlIHVzaW5nIHRoZSBoYW5kbGVyIG5hbWVcclxuICAgICAqIEBwYXJhbSBrZXlOYW1lIGNhbiBiZSBhIHN0cmluZ1xyXG4gICAgICovXHJcbiAgICByZXR1cm5WYWx1ZUZyb21BcGlTdG9yZVVzaW5nSGFuZGxlck5hbWUoa2V5TmFtZSkge1xyXG4gICAgICAgIGNvbnN0IGhhbmRsZXJWYWx1ZSA9XHJcbiAgICAgICAgICAgIHRoaXMuYXBpRGF0YVNlcnZpY2UuZ2V0QXBpRGF0YUJ5SGFuZGxlcih0aGlzLmNvbW1vblV0aWwuZ2V0SGFuZGxlck5hbWUoa2V5TmFtZSkpID9cclxuICAgICAgICAgICAgICAgIHRoaXMuYXBpRGF0YVNlcnZpY2UuZ2V0QXBpRGF0YUJ5SGFuZGxlcih0aGlzLmNvbW1vblV0aWwuZ2V0SGFuZGxlck5hbWUoa2V5TmFtZSkpLnZhbHVlIDoge307XHJcbiAgICAgICAgcmV0dXJuIGhhbmRsZXJWYWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBhbGwgZ2V0dGVyIHNldHRlcnMgZ29lcyBoZXJlXHJcbiAgICBnZXQgaXNTaW5nbGVBcGlLZXkoKSB7XHJcbiAgICAgICAgcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzaW5nbGVBcGlLZXknKSA9PT0gJ3RydWUnID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBpc0hhc2hlZEFwaUtleSgpIHtcclxuICAgICAgICByZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2hhc2hfYXBpX2tleScpID09PSAndHJ1ZScgPyB0cnVlIDogZmFsc2U7XHJcbiAgICB9XHJcbn1cclxuIl19